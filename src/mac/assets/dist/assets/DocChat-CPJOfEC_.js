import{a5 as Q,u as W,r as n,A as q,D as X,m as E,o as g,j as h,d as i,a as c,H as Y,c as H,x as K,t as w,s as A,b as o,i as M,e as z,a6 as ee,l as P,V as te,Z as O}from"./index-B9s1B9jQ.js";import{s as oe}from"./fileupload.esm-CQF3QjHR.js";import{s as le}from"./dropdown.esm-C8QGVjDp.js";import{_ as se,f as ae}from"./_plugin-vue_export-helper-D8ncxyMm.js";import{u as J}from"./dayjs.min-BF7iIa5r.js";import{u as ne}from"./Chat--HHEY9ML.js";import{h as ie,j as re,g as ce,n as de,c as ue}from"./knowledge-RiB-jk2J.js";import{b as pe,a as fe,g as T,f as Z}from"./FileIcon-CdRjaYE1.js";import{_ as me}from"./DocChatConfig-C3P-oQsp.js";import{M as ve}from"./Markdown-CsFcuW9P.js";import"./inputnumber.esm-CIhko8if.js";import"./slider.esm-BAPKB8wQ.js";import"./card.esm-B2Yyg_5c.js";import"./avatar.esm-3QHyxOKf.js";import"./FileViewer-DbFKQZGF.js";import"./index.esm-BP7LFGzw.js";const be={class:"flex items-center"},ge=["src"],he={class:"file-title overflow-hidden whitespace-nowrap break-all text-ellipsis max-w-[250px]"},_e={__name:"FileHistory",emits:["selectFile"],setup(G,{emit:a}){const f=Q(),$=W(),m=J(),d=n([]),u=n(0);function V(l,s){$.require({target:l.currentTarget,message:z("kb.deleteConfirmMsg"),icon:"pi pi-info-circle",rejectClass:"p-button-secondary p-button-outlined p-button-sm",acceptClass:"p-button-danger p-button-sm",rejectLabel:z("lang.cancel"),acceptLabel:z("kb.delete"),accept:()=>{re(s.id).then(()=>{f.add({severity:"success",summary:z("kb.success"),detail:z("kb.deleteSuccess"),life:3e3}),v()})}})}let _={page:1,pageSize:10};function D(){m.currentConversationId&&ie({id:m.currentConversationId,page:_.page,pagesize:_.pageSize}).then(l=>{const s=l.resData;d.value=s.data,u.value=s.total})}const y=n(0);function v(){_.page=1,y.value=0,D()}function B(l){_.page=l.page+1,_.pageSize=l.rows,D()}function x(l){const s=T(l);return Z(s)}const S=a;function N(l){S("selectFile",l)}return q(()=>{D()}),(l,s)=>{const C=pe,b=A,k=fe,j=X("tooltip");return g(),E(k,{lazy:"",value:o(d),paginator:o(u)>0,first:o(y),"onUpdate:first":s[0]||(s[0]=r=>M(y)?y.value=r:null),rows:10,rowsPerPageOptions:[10,20,30],totalRecords:o(u),stripedRows:"",rowHover:"",resizableColumns:"",dataKey:"id",onPage:B},{paginatorstart:h(()=>s[1]||(s[1]=[])),paginatorend:h(()=>[K(w(l.$t("kb.total"))+" "+w(o(u))+" "+w(l.$t("kb.items")),1)]),default:h(()=>[i(C,{field:"name",header:l.$t("kb.name")},{body:h(({data:r})=>[c("div",be,[c("img",{src:x(r.name),alt:"",style:{width:"25px","margin-right":"5px"}},null,8,ge),Y((g(),H("div",he,[K(w(r.name),1)])),[[j,r.name]])])]),_:1},8,["header"]),i(C,{field:"size",header:l.$t("kb.fileSize")},null,8,["header"]),i(C,{field:"createtime",header:l.$t("kb.uploadTime")},null,8,["header"]),i(C,{field:"operation",header:l.$t("kb.operation")},{body:h(r=>[i(b,{label:l.$t("kb.selectFile"),text:"",onClick:I=>N(r.data)},null,8,["label","onClick"]),i(b,{label:l.$t("kb.delete"),text:"",severity:"danger",onClick:I=>V(I,r.data)},null,8,["label","onClick"])]),_:1},8,["header"])]),_:1},8,["value","paginator","first","totalRecords"])}}},ye=se(_e,[["__scopeId","data-v-45373339"]]),ke={class:"file-container relative flex flex-col items-start justify-start w-[280px] -left-[28px] top-[50px] cursor-pointer overflow-hidden"},we={class:"flex justify-start items-center"},xe={class:"text-slate-500 font-bold text-sm"},Ce={class:"content-box"},Fe={class:"flex mt-2"},$e={key:0,class:"pi pi-spin pi-spinner mr-1"},De={key:1,class:"pi pi-file mr-1"},Se={key:0,class:"flex items-center w-full mt-2 cursor-pointer"},Ie=["src"],Re={class:"w-52 break-all whitespace-nowrap overflow-hidden text-ellipsis"},ze={class:"ml-4"},He=`
请前往 ⚙️<strong>【设置】</strong>-<strong>【嵌入模型】</strong> 中，进行模型选择与设置
`,Ge={__name:"DocChat",setup(G){const a=n([]),f=n(""),$=n(),m=J(),d=ne(),u=n(!1),V=e=>{const t=new FormData;t.append("id",m.currentConversationId),t.append("name",m.currentConversationId),t.append("knowledge_setting",JSON.stringify({embed_model:k.value})),e.files.length>0?e.files.forEach(p=>{t.append("files",p)}):t.append("files",new File([],"")),u.value=!0,a.value=[],ue(t).then(p=>{const L=p.resData;if(f.value=L[0],a.value=e.files,a.value.length>0){const U=a.value[0].name,R=T(U);d.setFileInfo({id:f.value,name:U,type:R})}$.value.clear(),$.value.uploadedFileCount=0,I()}).finally(()=>{u.value=!1})};function _(){const e=a.value[0].name,t=T(e);["txt","html","htm","md","json","jsonl","xml","pdf","docx"].includes(t)&&(d.setFileView(!0),d.setFileInfo({id:f.value,name:a.value[0].name,type:t}))}function D(){y()}function y(){a.value=[],f.value=[],d.setFileView(!1),d.setFileInfo({})}const v=n(!1);function B(e){f.value=e.id,a.value=[{id:e.id,name:e.name,size:e.bytetotal}],d.setFileInfo({id:f.value,name:e.name,type:T(e.name)}),s()}const x=n(!1),S=n(!1);function N(){v.value=!0,O(()=>{x.value=!0})}function l(){v.value=!0,O(()=>{S.value=!0})}function s(){v.value=!1,x.value=!1,S.value=!1}function C(e){const t=T(e);return Z(t)}const b=n(!1),k=n(""),j=n(!0),r=n([]);async function I(){try{const t=(await ce()).resData;if(r.value=t,r.value===null)b.value=!0;else{const p=await de(m.currentConversationId);k.value=p.resData.local_path,j.value=p.resData.is_editable}}catch(e){console.error("获取模型失败:",e),b.value=!0}}return q(()=>{I().then(()=>{r.value!==null&&V({files:[]})})}),ee(()=>{d.clearPluginData()}),(e,t)=>{const p=le,L=te,U=oe,R=A;return g(),H("div",null,[c("div",ke,[c("div",we,[c("label",xe,w(e.$t("kb.embedModelPath")),1),i(p,{class:"w-[200px] ml-2",modelValue:o(k),"onUpdate:modelValue":t[0]||(t[0]=F=>M(k)?k.value=F:null),options:o(r),optionLabel:"name",optionValue:"local_path",disabled:!o(j)},null,8,["modelValue","options","disabled"])]),i(L,{visible:o(b),"onUpdate:visible":t[1]||(t[1]=F=>M(b)?b.value=F:null),header:"未检测到可使用的【嵌入模型】",style:{width:"800px"},modal:!0},{default:h(()=>[c("div",Ce,[i(ve,{content:He})])]),_:1},8,["visible"]),c("div",Fe,[i(U,{mode:"basic",name:"uploader",ref_key:"uploaderRef",ref:$,url:"",accept:".pdf,.docx,.txt,.html,.htm,.md,.json,.jsonl,.epub,.mobi,.xml,.pptx","choose-label":e.$t("kb.selectFile"),"upload-icon":"pi pi-file",maxFileSize:500*1024*1024,auto:"",customUpload:"",onUploader:V,onSelect:D,disabled:o(u),pt:{chooseButton:{class:"p-button-text"}}},{uploadicon:h(()=>[o(u)?(g(),H("i",$e)):(g(),H("i",De))]),_:1},8,["choose-label","disabled"]),c("div",null,[i(R,{icon:"pi pi-clock",text:"",label:e.$t("kb.fileHistory"),onClick:N},null,8,["label"]),i(R,{text:"",onClick:l,label:e.$t("lang.config")},null,8,["label"])])]),o(a).length>0?(g(),H("div",Se,[c("img",{src:C(o(a)[0].name),alt:"",style:{width:"35px","margin-right":"5px"}},null,8,Ie),c("div",{onClick:_},[c("div",Re,w(o(a)[0].name),1),c("div",null,w(o(ae)(o(a)[0].size)),1)]),c("div",ze,[i(R,{icon:"pi pi-times",onClick:t[2]||(t[2]=F=>y()),rounded:"",text:"",severity:"danger"})])])):P("",!0)]),i(L,{visible:o(v),"onUpdate:visible":t[3]||(t[3]=F=>M(v)?v.value=F:null),modal:"",header:o(x)?e.$t("kb.fileHistory"):e.$t("lang.config"),class:"w-2/5 min-w-[600px]",onHide:s},{default:h(()=>[o(x)?(g(),E(ye,{key:0,ref:"fileHistoryRef",onSelectFile:B,onHide:s},null,512)):P("",!0),o(S)?(g(),E(me,{key:1,ref:"docChatConfigRef",kbId:o(m).currentConversationId,sessionId:o(m).currentConversationId,type:"chat_files_retrievers",onSuccess:s,onHide:s},null,8,["kbId","sessionId"])):P("",!0)]),_:1},8,["visible","header"])])}}};export{Ge as default};
