import{a5 as Q,u as W,r as a,A as q,D as X,m as E,o as b,j as g,d as n,a as r,H as Y,c as R,x as K,t as w,s as A,b as o,i as M,e as H,a6 as ee,l as P,V as te,Z as O}from"./index-DsCI1JGZ.js";import{s as oe}from"./fileupload.esm-B8PI0tTy.js";import{s as le}from"./dropdown.esm-DwDSFSV0.js";import{_ as se,f as ie}from"./_plugin-vue_export-helper-B6P66phQ.js";import{u as J}from"./dayjs.min-CUDIH8s6.js";import{u as ae}from"./Chat-D6Gx9uXN.js";import{h as ne,j as re,g as ce,n as de,c as ue}from"./knowledge-D6CcdkcR.js";import{b as pe,a as fe,g as T,f as Z}from"./FileIcon-o_6PM4H_.js";import{_ as me}from"./DocChatConfig-Cjd81p2K.js";import{M as ve}from"./Markdown-79OaREfC.js";import"./inputnumber.esm-CwPOo8Kc.js";import"./slider.esm-CuahDGIa.js";import"./card.esm-DqFHreHx.js";import"./avatar.esm-B8L5TEF_.js";import"./FileViewer-Bt7h_CCz.js";import"./index.esm-DAmkHKz_.js";const be={class:"flex items-center"},ge=["src"],he={class:"file-title overflow-hidden whitespace-nowrap break-all text-ellipsis max-w-[250px]"},_e={__name:"FileHistory",emits:["selectFile"],setup(G,{emit:i}){const f=Q(),$=W(),m=J(),d=a([]),u=a(0);function V(l,s){$.require({target:l.currentTarget,message:H("kb.deleteConfirmMsg"),icon:"pi pi-info-circle",rejectClass:"p-button-secondary p-button-outlined p-button-sm",acceptClass:"p-button-danger p-button-sm",rejectLabel:H("lang.cancel"),acceptLabel:H("kb.delete"),accept:()=>{re(s.id).then(()=>{f.add({severity:"success",summary:H("kb.success"),detail:H("kb.deleteSuccess"),life:3e3}),v()})}})}let h={page:1,pageSize:10};function D(){m.currentConversationId&&ne({id:m.currentConversationId,page:h.page,pagesize:h.pageSize}).then(l=>{const s=l.resData;d.value=s.data,u.value=s.total})}const _=a(0);function v(){h.page=1,_.value=0,D()}function B(l){h.page=l.page+1,h.pageSize=l.rows,D()}function x(l){const s=T(l);return Z(s)}const S=i;function N(l){S("selectFile",l)}return q(()=>{D()}),(l,s)=>{const C=pe,y=A,k=fe,j=X("tooltip");return b(),E(k,{lazy:"",value:o(d),paginator:o(u)>0,first:o(_),"onUpdate:first":s[0]||(s[0]=c=>M(_)?_.value=c:null),rows:10,rowsPerPageOptions:[10,20,30],totalRecords:o(u),stripedRows:"",rowHover:"",resizableColumns:"",dataKey:"id",onPage:B},{paginatorstart:g(()=>s[1]||(s[1]=[])),paginatorend:g(()=>[K(w(l.$t("kb.total"))+" "+w(o(u))+" "+w(l.$t("kb.items")),1)]),default:g(()=>[n(C,{field:"name",header:l.$t("kb.name")},{body:g(({data:c})=>[r("div",be,[r("img",{src:x(c.name),alt:"",style:{width:"25px","margin-right":"5px"}},null,8,ge),Y((b(),R("div",he,[K(w(c.name),1)])),[[j,c.name]])])]),_:1},8,["header"]),n(C,{field:"size",header:l.$t("kb.fileSize")},null,8,["header"]),n(C,{field:"createtime",header:l.$t("kb.uploadTime")},null,8,["header"]),n(C,{field:"operation",header:l.$t("kb.operation")},{body:g(c=>[n(y,{label:l.$t("kb.selectFile"),text:"",onClick:I=>N(c.data)},null,8,["label","onClick"]),n(y,{label:l.$t("kb.delete"),text:"",severity:"danger",onClick:I=>V(I,c.data)},null,8,["label","onClick"])]),_:1},8,["header"])]),_:1},8,["value","paginator","first","totalRecords"])}}},ye=se(_e,[["__scopeId","data-v-45373339"]]),ke={class:"file-container relative flex flex-col items-start justify-start w-[280px] -left-[28px] top-[50px] cursor-pointer overflow-hidden"},we={class:"flex justify-start items-center"},xe={class:"text-slate-500 font-bold text-sm"},Ce={class:"content-box"},Fe={class:"flex mt-2"},$e={key:0,class:"pi pi-spin pi-spinner mr-1"},De={key:1,class:"pi pi-file mr-1"},Se={key:0,class:"flex items-center w-full mt-2 cursor-pointer"},Ie=["src"],ze={class:"w-52 break-all whitespace-nowrap overflow-hidden text-ellipsis"},He={class:"ml-4"},Re=`
未检测到相关嵌入模型，请前往设置中添加
`,Ge={__name:"DocChat",setup(G){const i=a([]),f=a(""),$=a(),m=J(),d=ae(),u=a(!1),V=e=>{const t=new FormData;t.append("id",m.currentConversationId),t.append("name",m.currentConversationId),t.append("knowledge_setting",JSON.stringify({embed_model:k.value})),e.files.length>0?e.files.forEach(p=>{t.append("files",p)}):t.append("files",new File([],"")),u.value=!0,i.value=[],ue(t).then(p=>{const L=p.resData;if(f.value=L[0],i.value=e.files,i.value.length>0){const U=i.value[0].name,z=T(U);d.setFileInfo({id:f.value,name:U,type:z})}$.value.clear(),$.value.uploadedFileCount=0,I()}).finally(()=>{u.value=!1})};function h(){const e=i.value[0].name,t=T(e);["txt","html","htm","md","json","jsonl","xml","pdf","docx"].includes(t)&&(d.setFileView(!0),d.setFileInfo({id:f.value,name:i.value[0].name,type:t}))}function D(){_()}function _(){i.value=[],f.value=[],d.setFileView(!1),d.setFileInfo({})}const v=a(!1);function B(e){f.value=e.id,i.value=[{id:e.id,name:e.name,size:e.bytetotal}],d.setFileInfo({id:f.value,name:e.name,type:T(e.name)}),s()}const x=a(!1),S=a(!1);function N(){v.value=!0,O(()=>{x.value=!0})}function l(){v.value=!0,O(()=>{S.value=!0})}function s(){v.value=!1,x.value=!1,S.value=!1}function C(e){const t=T(e);return Z(t)}const y=a(!1),k=a(""),j=a(!0),c=a([]);function I(){return ce().then(async e=>{const t=e.resData;c.value=t,c.value===null?y.value=!0:await de(m.currentConversationId).then(p=>{k.value=p.resData.local_path,j.value=p.resData.is_editable})})}return q(()=>{I().then(()=>{V({files:[]})})}),ee(()=>{d.clearPluginData()}),(e,t)=>{const p=le,L=te,U=oe,z=A;return b(),R("div",null,[r("div",ke,[r("div",we,[r("label",xe,w(e.$t("kb.embedModelPath")),1),n(p,{class:"w-[200px] ml-2",modelValue:o(k),"onUpdate:modelValue":t[0]||(t[0]=F=>M(k)?k.value=F:null),options:o(c),optionLabel:"name",optionValue:"local_path",disabled:!o(j)},null,8,["modelValue","options","disabled"])]),n(L,{visible:o(y),"onUpdate:visible":t[1]||(t[1]=F=>M(y)?y.value=F:null),header:"请在设置中添加嵌入模型",style:{width:"800px"},modal:!0},{default:g(()=>[r("div",Ce,[n(ve,{content:Re})])]),_:1},8,["visible"]),r("div",Fe,[n(U,{mode:"basic",name:"uploader",ref_key:"uploaderRef",ref:$,url:"",accept:".pdf,.docx,.txt,.html,.htm,.md,.json,.jsonl,.epub,.mobi,.xml,.pptx","choose-label":e.$t("kb.selectFile"),"upload-icon":"pi pi-file",maxFileSize:500*1024*1024,auto:"",customUpload:"",onUploader:V,onSelect:D,disabled:o(u),pt:{chooseButton:{class:"p-button-text"}}},{uploadicon:g(()=>[o(u)?(b(),R("i",$e)):(b(),R("i",De))]),_:1},8,["choose-label","disabled"]),r("div",null,[n(z,{icon:"pi pi-clock",text:"",label:e.$t("kb.fileHistory"),onClick:N},null,8,["label"]),n(z,{text:"",onClick:l,label:e.$t("lang.config")},null,8,["label"])])]),o(i).length>0?(b(),R("div",Se,[r("img",{src:C(o(i)[0].name),alt:"",style:{width:"35px","margin-right":"5px"}},null,8,Ie),r("div",{onClick:h},[r("div",ze,w(o(i)[0].name),1),r("div",null,w(o(ie)(o(i)[0].size)),1)]),r("div",He,[n(z,{icon:"pi pi-times",onClick:t[2]||(t[2]=F=>_()),rounded:"",text:"",severity:"danger"})])])):P("",!0)]),n(L,{visible:o(v),"onUpdate:visible":t[3]||(t[3]=F=>M(v)?v.value=F:null),modal:"",header:o(x)?e.$t("kb.fileHistory"):e.$t("lang.config"),class:"w-2/5 min-w-[600px]",onHide:s},{default:g(()=>[o(x)?(b(),E(ye,{key:0,ref:"fileHistoryRef",onSelectFile:B,onHide:s},null,512)):P("",!0),o(S)?(b(),E(me,{key:1,ref:"docChatConfigRef",kbId:o(m).currentConversationId,sessionId:o(m).currentConversationId,type:"chat_files_retrievers",onSuccess:s,onHide:s},null,8,["kbId","sessionId"])):P("",!0)]),_:1},8,["visible","header"])])}}};export{Ge as default};
