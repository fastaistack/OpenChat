<p align="left">
  <a href="../../README.md">返回</a> 

## Windows打包流程和配置方法
构建windows环境下应用安装包需依赖以下环境和应用
- **Python环境**：Python3.10.11/3.10.12  
- **打包工具**：Inno Setup Compiler
### 1 安装Python环境
下载Python安装包：访问[Python官方网站](https://www.python.org/)，下载Python3.10.11
### 2 构建打包虚拟环境
激活先前部署的Python环境
```shell
pip install virtualenv
virtualenv venv --python=python3.10.11
```
### 3 在打包环境中安装项目依赖
进入打包环境venv中激活此环境，根据此项目提供的requirements.txt安装依赖
```shell
pip install -r requirements.txt
```
请修改pypandoc包中的init.py中的部分代码
```python
stdout.decode('utf-8') ---> stdout
```
请修改pytesseract包的pytesseract.py中的部分代码
```python
tesseract_cmd = r'.\_internal\Tesseract_OCR\tesseract.exe'
```
请将项目提供的nltk_data放入虚拟环境的./venv/Lib下
### 4 构建可执行文件exe
使用pyinstaller在项目根目录下生成openchat.spec文件
```shell
pyinstaller -D openchat.py
```
执行openchat.spec，在项目根目录下生成一个build文件夹和dist文件夹，其中dist文件夹是最终生成与应用安装包相关的内容
```shell
pyinstaller opeanchat.spec
```
在项目中可以看到依赖包_internal、前端asset、openchat.exe
![](../../data/images/packaging/windows.png)
请使用powershell执行openchat.exe，通常会在控制台打印出缺少依赖包的错误，请在虚拟环境./venv/Lib/site-packages中将缺少的依赖包添加进_internal中；
除了缺少的依赖包以外，请将pkg、Tesseract_OCR和poppler-0.89.0放入_internal中；
请将项目中提供urllib添加至_internal中
### 5 构建应用程序安装包
官网下载[Inno Setup Compiler](https://jrsoftware.org/isdl.php)，本项目提供应用构建脚本openchatsetup.iss，请将个人打包路径名称填充完整，其他参数请根据个人需要进行修改，构建过程视电脑配置而定，通常保持在10-15分钟间
```pascal
; Script generated by the Inno Setup Script Wizard.
; SEE THE DOCUMENTATION FOR DETAILS ON CREATING INNO SETUP SCRIPT FILES!

#define MyAppName "OpenChat"
#define MyAppVersion "1.0"
#define MyAppPublisher "xxx"
#define MyAppURL "https://www.xxx.com/"
#define MyAppExeName "openchat.exe"
#define MyAppAssocName MyAppName + " File"
#define MyAppAssocExt ".myp"
#define MyAppAssocKey StringChange(MyAppAssocName, " ", "") + MyAppAssocExt

[Setup]
; NOTE: The value of AppId uniquely identifies this application. Do not use the same AppId value in installers for other applications.
; (To generate a new GUID, click Tools | Generate GUID inside the IDE.)
AppId={{D8996EC5-54ED-4916-B820-E79C648E59A8}
AppName={#MyAppName}
AppVersion={#MyAppVersion}
;AppVerName={#MyAppName} {#MyAppVersion}
AppPublisher={#MyAppPublisher}
AppPublisherURL={#MyAppURL}
AppSupportURL={#MyAppURL}
AppUpdatesURL={#MyAppURL}
DefaultDirName={autopf}\{#MyAppName}
; "ArchitecturesAllowed=x64compatible" specifies that Setup cannot run
; on anything but x64 and Windows 11 on Arm.
ArchitecturesAllowed=x64compatible
; "ArchitecturesInstallIn64BitMode=x64compatible" requests that the
; install be done in "64-bit mode" on x64 or Windows 11 on Arm,
; meaning it should use the native 64-bit Program Files directory and
; the 64-bit view of the registry.
ArchitecturesInstallIn64BitMode=x64compatible
ChangesAssociations=yes
DisableProgramGroupPage=yes
LicenseFile=/xxx/xxx/xxx // LicenseFile文件
; Uncomment the following line to run in non administrative install mode (install for current user only.)
;PrivilegesRequired=lowest
OutputDir=/xxx/xxx/xxx // exe打包后输出的文件
OutputBaseFilename=OpenChatSetup
SetupIconFile=/xxx/xxx/xxx // exe安装图标
Compression=lzma
SolidCompression=yes
WizardStyle=modern

[Code]
procedure CurStepChanged(CurStep: TSetupStep);
var
  uninspath, uninsname, NewUninsName, MyAppName: string;
  sUnInstPath: String;
  sUnInstallExe: String;
  iResultCode: Integer;
  OldFilePath, NewFilePath: string;
  FilePath: string;
begin

  if CurStep = ssInstall then
  begin
    sUnInstPath := ExpandConstant('SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\');
    sUnInstallExe := '';
    if RegQueryStringValue(HKEY_LOCAL_MACHINE, sUnInstPath, '{#MyAppName}_unisl', sUnInstallExe) then
    begin
      sUnInstallExe := RemoveQuotes(sUnInstallExe);
      Exec(sUnInstallExe, '/SILENT /NORESTART', '', SW_HIDE, ewWaitUntilTerminated, iResultCode)
      // 删除旧版本的数据表
      FilePath := ExpandConstant('C:\Users\{%username|DefaultValue}\.openchat\openchat_old.db');
      if FileExists(FilePath) then
      begin
        DeleteFile(FilePath);
      end
    end
   end;


  if CurStep = ssDone then
  begin
    NewUninsName := 'OpenChatUninstall';
    MyAppName := '{#MyAppName}';
    
    // 重命名卸载文件
    uninspath := ExtractFilePath(ExpandConstant('{uninstallexe}'));
    uninsname := Copy(ExtractFileName(ExpandConstant('{uninstallexe}')), 1, 8);
    RenameFile(uninspath + uninsname + '.exe', uninspath + NewUninsName + '.exe');
    RenameFile(uninspath + uninsname + '.dat', uninspath + NewUninsName + '.dat');

    // 重命名db
    OldFilePath := ExpandConstant('C:\Users\{%username|DefaultValue}\.openchat\openchat.db');
    NewFilePath := ExpandConstant('C:\Users\{%username|DefaultValue}\.openchat\openchat_old.db');
    if FileExists(OldFilePath) then
    begin
      RenameFile(OldFilePath, NewFilePath);
    end
  end;
end;


[Languages]
Name: "english"; MessagesFile: "compiler:Default.isl"

[Tasks]
Name: "desktopicon"; Description: "{cm:CreateDesktopIcon}"; GroupDescription: "{cm:AdditionalIcons}"; Flags: unchecked

[Files]
// 此处请填入通过pyinstaller打包后的完整路径
Source: "xxx\dist\yuanchat\{#MyAppExeName}"; DestDir: "{app}"; Flags: ignoreversion
Source: "xxx\dist\yuanchat\*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs createallsubdirs
; NOTE: Don't use "Flags: ignoreversion" on any shared system files

[Registry]
Root: HKLM; Subkey: "Software\Microsoft\Windows\CurrentVersion\Uninstall\"; ValueType: string; ValueName: "{#MyAppName}_unisl"; ValueData: "{app}\OpenChatUninstall.exe";Flags: uninsdeletevalue

[Icons]
Name: "{autoprograms}\{#MyAppName}"; Filename: "{app}\{#MyAppExeName}"
Name: "{autodesktop}\{#MyAppName}"; Filename: "{app}\{#MyAppExeName}"; Tasks: desktopicon

[Run]
Filename: "{app}\{#MyAppExeName}"; Description: "{cm:LaunchProgram,{#StringChange(MyAppName, '&', '&&')}}"; Flags: nowait postinstall skipifsilent


```
